<!DOCTYPE html>
<html>
  <body>
    <center><h1>Hello , Welcome to my chat site ! {{request.user}}</h1></center>
    <br />
    {% if request.user.is_authenticated %}
    <center>
      Logout the chat Page <a href="{% url 'logout-user' %}">Logout</a>
    </center>
    {% endif %}
    <div
      class="chat__item__container"
      id="id_chat_item_container"
      style="font-size: 20px"
    >
      <br />
      <input type="text" id="id_message_send_input" />
      <button type="submit" id="id_message_send_button">Send Message</button>
      <br />
      <br />
    </div>
    <script>
      // Create a WebSocket connection to the current host
      const chatSocket = new WebSocket(`ws://${window.location.host}/`);

      // Handle when the WebSocket connection is opened
      chatSocket.addEventListener("open", function (event) {
        console.log("WebSocket connection established!");
      });

      // Handle when the WebSocket connection is closed
      chatSocket.addEventListener("close", function (event) {
        console.log("WebSocket connection closed unexpectedly!");
      });

      // Focus on the input field when the page loads
      document.querySelector("#id_message_send_input").focus();

      // Handle when the user presses enter in the input field
      document
        .querySelector("#id_message_send_input")
        .addEventListener("keyup", function (event) {
          if (event.keyCode === 13) {
            event.preventDefault();
            document.querySelector("#id_message_send_button").click();
          }
        });

      // Handle when the user clicks the send button
      document
        .querySelector("#id_message_send_button")
        .addEventListener("click", function (event) {
          event.preventDefault();
          const messageInput = document.querySelector("#id_message_send_input");
          const message = messageInput.value;
          if (message.trim() === "") {
            return;
          }
          const username = "{{request.user.username}}";
          const data = { message: message, username: username };
          chatSocket.send(JSON.stringify(data));
          messageInput.value = "";
        });

      // Handle when a message is received from the server
      chatSocket.addEventListener("message", function (event) {
        const data = JSON.parse(event.data);
        const messageContainer = document.querySelector(
          "#id_chat_item_container"
        );
        const messageElement = document.createElement("div");
        messageElement.textContent = `${data.username}: ${data.message}`;
        messageContainer.appendChild(messageElement);
      });
    </script>
  </body>
</html>
